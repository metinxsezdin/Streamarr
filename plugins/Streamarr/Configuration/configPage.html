<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Streamarr</title>
</head>
<body>
    <div id="StreamarrConfigPage" data-role="page" class="page type-interior pluginConfigurationPage" data-require="emby-input,emby-button,emby-checkbox">
        <div data-role="content">
            <div class="content-primary">
                <form id="StreamarrConfigForm">
                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="resolverBaseUrl">Resolver API URL</label>
                        <input id="resolverBaseUrl" name="resolverBaseUrl" type="text" is="emby-input" required />
                        <div class="fieldDescription">Example: http://127.0.0.1:5055</div>
                    </div>

                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="apiKey">API Key</label>
                        <input id="apiKey" name="apiKey" type="text" is="emby-input" />
                        <div class="fieldDescription">(Optional)</div>
                    </div>

                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="catalogCacheMinutes">Catalog Cache (minutes)</label>
                        <input id="catalogCacheMinutes" name="catalogCacheMinutes" type="number" min="1" max="1440" is="emby-input" />
                        <div class="fieldDescription">Set how long the resolver catalog should be cached.</div>
                    </div>

                    <div class="checkboxContainer checkboxContainer-withDescription">
                        <label class="emby-checkbox-label" for="disableCatalogCache">
                            <input id="disableCatalogCache" name="disableCatalogCache" type="checkbox" is="emby-checkbox" />
                            <span>Disable catalog cache</span>
                        </label>
                        <div class="fieldDescription">When enabled, the catalog is refreshed on every request.</div>
                    </div>

                    <button is="emby-button" type="submit" class="raised button-submit block">
                        <span>Save Settings</span>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        var StreamarrConfig = {
            pluginUniqueId: "68c71f7d-a14e-4f21-9e10-7c02f51ae7b0"
        };

        document.querySelector('#StreamarrConfigPage').addEventListener('pageshow', function () {
            Dashboard.showLoadingMsg();
            ApiClient.getPluginConfiguration(StreamarrConfig.pluginUniqueId).then(function (config) {
                document.querySelector('#resolverBaseUrl').value = config.ResolverBaseUrl || '';
                document.querySelector('#apiKey').value = config.ApiKey || '';
                document.querySelector('#catalogCacheMinutes').value = config.CatalogCacheMinutes || 10;
                document.querySelector('#disableCatalogCache').checked = !!config.DisableCatalogCache;
                Dashboard.hideLoadingMsg();
            }).catch(function (err) {
                console.error('Streamarr config load failed', err);
                Dashboard.alert({ message: 'Failed to load settings: ' + err.message });
                Dashboard.hideLoadingMsg();
            });
        });

        document.querySelector('#StreamarrConfigForm').addEventListener('submit', function (e) {
            e.preventDefault();
            Dashboard.showLoadingMsg();

            ApiClient.getPluginConfiguration(StreamarrConfig.pluginUniqueId).then(function (config) {
                config.ResolverBaseUrl = document.querySelector('#resolverBaseUrl').value.trim();
                config.ApiKey = document.querySelector('#apiKey').value.trim();
                config.CatalogCacheMinutes = parseInt(document.querySelector('#catalogCacheMinutes').value, 10) || 10;
                config.DisableCatalogCache = document.querySelector('#disableCatalogCache').checked;
                config.EnabledProviders = config.EnabledProviders || [];

                return ApiClient.updatePluginConfiguration(StreamarrConfig.pluginUniqueId, config);
            }).then(function (result) {
                Dashboard.processPluginConfigurationUpdateResult(result);
            }).catch(function (err) {
                Dashboard.alert({ message: 'Save failed: ' + (err && err.message ? err.message : err) });
            }).finally(function () {
                Dashboard.hideLoadingMsg();
            });
        });
    </script>
</body>
</html>
